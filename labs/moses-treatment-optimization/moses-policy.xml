<!--
    MOSES Treatment Optimization Policy
    Meta-Optimizing Semantic Evolutionary Search for dermatology treatment patterns

    This policy implements:
    1. Request validation for optimization parameters
    2. Medical constraints enforcement
    3. Evolutionary algorithm configuration
    4. Clinical evidence validation
    5. Safety boundaries for treatment recommendations
-->
<policies>
    <inbound>
        <base />

        <!-- Validate MOSES API Key -->
        <validate-azure-ad-token tenant-id="{{tenant-id}}" failed-validation-httpcode="401" failed-validation-error-message="Unauthorized: Invalid MOSES access token">
            <audiences>
                <audience>{{moses-api-audience}}</audience>
            </audiences>
        </validate-azure-ad-token>

        <!-- Set MOSES operation context -->
        <set-variable name="mosesOperation" value="@(context.Operation.Id)" />
        <set-variable name="requestBody" value="@(context.Request.Body.As<JObject>(preserveContent: true))" />

        <!-- Validate optimization request structure -->
        <choose>
            <when condition="@(context.Operation.Id == "optimize-treatment")">
                <!-- Validate required fields for optimization -->
                <set-variable name="condition" value="@{
                    var body = (JObject)context.Variables["requestBody"];
                    return body?["condition"]?.ToString() ?? "";
                }" />

                <choose>
                    <when condition="@(string.IsNullOrEmpty((string)context.Variables["condition"]))">
                        <return-response>
                            <set-status code="400" reason="Bad Request" />
                            <set-body>@{
                                return new JObject(
                                    new JProperty("error", "validation_error"),
                                    new JProperty("message", "Missing required field: condition"),
                                    new JProperty("field", "condition"),
                                    new JProperty("hint", "Specify a dermatological condition to optimize treatment for")
                                ).ToString();
                            }</set-body>
                        </return-response>
                    </when>
                </choose>

                <!-- Validate condition is in supported list -->
                <set-variable name="supportedConditions" value="@{
                    return new JArray("acne_vulgaris", "psoriasis", "eczema", "rosacea",
                                      "melasma", "seborrheic_dermatitis", "alopecia",
                                      "hyperpigmentation", "vitiligo", "dermatitis",
                                      "urticaria", "keratosis_pilaris");
                }" />

                <choose>
                    <when condition="@{
                        var condition = (string)context.Variables["condition"];
                        var supported = (JArray)context.Variables["supportedConditions"];
                        return !supported.Any(c => c.ToString().Equals(condition, StringComparison.OrdinalIgnoreCase));
                    }">
                        <return-response>
                            <set-status code="400" reason="Bad Request" />
                            <set-body>@{
                                var supported = (JArray)context.Variables["supportedConditions"];
                                return new JObject(
                                    new JProperty("error", "unsupported_condition"),
                                    new JProperty("message", $"Condition not supported for optimization"),
                                    new JProperty("condition", (string)context.Variables["condition"]),
                                    new JProperty("supported_conditions", supported)
                                ).ToString();
                            }</set-body>
                        </return-response>
                    </when>
                </choose>
            </when>
        </choose>

        <!-- Medical safety constraints validation -->
        <set-variable name="medicalConstraints" value="@{
            var body = (JObject)context.Variables["requestBody"];
            var constraints = body?["constraints"] as JObject ?? new JObject();

            // Enforce mandatory medical safety constraints
            var safetyConstraints = new JObject();

            // Always avoid known dangerous combinations
            var avoidIngredients = constraints["avoid_ingredients"] as JArray ?? new JArray();
            var mandatoryAvoid = new JArray("hydroquinone_high_concentration", "mercury", "steroids_unsupervised");
            foreach (var item in mandatoryAvoid) {
                if (!avoidIngredients.Any(a => a.ToString() == item.ToString())) {
                    avoidIngredients.Add(item);
                }
            }
            safetyConstraints["avoid_ingredients"] = avoidIngredients;

            // Enforce maximum treatment duration
            var maxDuration = constraints["max_duration_weeks"]?.Value<int>() ?? 12;
            safetyConstraints["max_duration_weeks"] = Math.Min(maxDuration, 24); // Cap at 24 weeks

            // Require medical supervision for certain conditions
            var condition = body?["condition"]?.ToString() ?? "";
            var requiresSupervision = new[] { "psoriasis", "vitiligo", "severe_eczema" };
            if (requiresSupervision.Contains(condition.ToLower())) {
                safetyConstraints["requires_medical_supervision"] = true;
            }

            return safetyConstraints;
        }" />

        <!-- Set MOSES algorithm parameters -->
        <set-variable name="mosesParams" value="@{
            var body = (JObject)context.Variables["requestBody"];
            var params = new JObject();

            // Population size (limit for resource management)
            var popSize = body?["algorithm_params"]?["population_size"]?.Value<int>() ?? 500;
            params["population_size"] = Math.Min(popSize, 2000);

            // Generation limit
            var maxGen = body?["algorithm_params"]?["max_generations"]?.Value<int>() ?? 50;
            params["max_generations"] = Math.Min(maxGen, 200);

            // Tournament selection size
            params["tournament_size"] = body?["algorithm_params"]?["tournament_size"]?.Value<int>() ?? 7;

            // Genetic operators
            params["crossover_rate"] = body?["algorithm_params"]?["crossover_rate"]?.Value<double>() ?? 0.8;
            params["mutation_rate"] = body?["algorithm_params"]?["mutation_rate"]?.Value<double>() ?? 0.1;

            // Fitness function configuration
            params["fitness_weights"] = new JObject(
                new JProperty("clinical_efficacy", 0.4),
                new JProperty("safety_score", 0.3),
                new JProperty("patient_adherence", 0.15),
                new JProperty("cost_effectiveness", 0.15)
            );

            return params;
        }" />

        <!-- Add MOSES context headers -->
        <set-header name="X-MOSES-Operation" exists-action="override">
            <value>@((string)context.Variables["mosesOperation"])</value>
        </set-header>
        <set-header name="X-MOSES-Params" exists-action="override">
            <value>@(((JObject)context.Variables["mosesParams"]).ToString(Newtonsoft.Json.Formatting.None))</value>
        </set-header>
        <set-header name="X-Medical-Constraints" exists-action="override">
            <value>@(((JObject)context.Variables["medicalConstraints"]).ToString(Newtonsoft.Json.Formatting.None))</value>
        </set-header>

        <!-- Rate limiting for optimization requests -->
        <rate-limit-by-key calls="10" renewal-period="60" counter-key="@(context.Subscription.Id + "-moses")" />

        <!-- Quota for expensive optimization operations -->
        <quota-by-key calls="100" renewal-period="86400" counter-key="@(context.Subscription.Id + "-moses-daily")" />

        <!-- Route to appropriate backend based on operation complexity -->
        <choose>
            <when condition="@(context.Operation.Id == "optimize-treatment")">
                <set-backend-service backend-id="moses-optimizer-backend" />
            </when>
            <when condition="@(context.Operation.Id == "evaluate-protocol")">
                <set-backend-service backend-id="moses-evaluator-backend" />
            </when>
            <when condition="@(context.Operation.Id == "mine-patterns")">
                <set-backend-service backend-id="moses-pattern-miner-backend" />
            </when>
            <otherwise>
                <set-backend-service backend-id="{backend-id}" />
            </otherwise>
        </choose>
    </inbound>

    <backend>
        <base />

        <!-- Retry logic for long-running optimizations -->
        <retry condition="@(context.Response.StatusCode >= 500)" count="3" interval="5" first-fast-retry="false">
            <forward-request timeout="300" /> <!-- 5 minute timeout for complex optimizations -->
        </retry>
    </backend>

    <outbound>
        <base />

        <!-- Validate optimization results -->
        <choose>
            <when condition="@(context.Response.StatusCode == 200 && context.Operation.Id == "optimize-treatment")">
                <set-variable name="responseBody" value="@(context.Response.Body.As<JObject>(preserveContent: true))" />

                <!-- Add clinical disclaimers -->
                <set-body>@{
                    var response = (JObject)context.Variables["responseBody"];

                    // Add medical disclaimer
                    response["disclaimer"] = new JObject(
                        new JProperty("message", "These treatment recommendations are generated by AI and should be reviewed by a qualified dermatologist before implementation."),
                        new JProperty("medical_supervision_required", true),
                        new JProperty("evidence_level", "algorithmic_optimization"),
                        new JProperty("regulatory_status", "not_fda_approved")
                    );

                    // Add optimization metadata
                    response["optimization_metadata"] = new JObject(
                        new JProperty("algorithm", "MOSES"),
                        new JProperty("version", "1.0"),
                        new JProperty("timestamp", DateTime.UtcNow.ToString("o")),
                        new JProperty("parameters", context.Variables["mosesParams"])
                    );

                    // Add safety annotations to each recommendation
                    var recommendations = response["recommendations"] as JArray;
                    if (recommendations != null) {
                        foreach (JObject rec in recommendations) {
                            rec["safety_validated"] = true;
                            rec["requires_patch_test"] = true;
                            rec["contraindication_check_required"] = true;
                        }
                    }

                    return response.ToString();
                }</set-body>
            </when>
        </choose>

        <!-- Add MOSES response headers -->
        <set-header name="X-MOSES-Version" exists-action="override">
            <value>1.0</value>
        </set-header>
        <set-header name="X-MOSES-Optimization-Id" exists-action="override">
            <value>@(Guid.NewGuid().ToString())</value>
        </set-header>
        <set-header name="X-Medical-Disclaimer" exists-action="override">
            <value>AI-generated recommendations require professional medical review</value>
        </set-header>

        <!-- Emit optimization metrics -->
        <emit-metric name="moses_optimization_request" value="1" namespace="moses">
            <dimension name="operation" value="@(context.Operation.Id)" />
            <dimension name="condition" value="@((string)context.Variables.GetValueOrDefault("condition", "unknown"))" />
            <dimension name="success" value="@(context.Response.StatusCode == 200 ? "true" : "false")" />
        </emit-metric>
    </outbound>

    <on-error>
        <base />

        <!-- Handle MOSES-specific errors -->
        <choose>
            <when condition="@(context.LastError.Source == "moses-optimizer")">
                <return-response>
                    <set-status code="500" reason="Optimization Error" />
                    <set-body>@{
                        return new JObject(
                            new JProperty("error", "optimization_failed"),
                            new JProperty("message", "Treatment optimization could not be completed"),
                            new JProperty("details", context.LastError.Message),
                            new JProperty("recommendation", "Please try with simpler constraints or contact support"),
                            new JProperty("request_id", context.RequestId)
                        ).ToString();
                    }</set-body>
                </return-response>
            </when>
        </choose>

        <!-- Log optimization failures -->
        <emit-metric name="moses_optimization_error" value="1" namespace="moses">
            <dimension name="error_type" value="@(context.LastError.Reason)" />
            <dimension name="operation" value="@(context.Operation.Id)" />
        </emit-metric>
    </on-error>
</policies>
